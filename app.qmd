---
title: "äººå£ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—"
format: 
  dashboard: 
    theme: minty
    nav-buttons: 
      - icon: house-door-fill
        href: https://yo5uke.com/pages/software/
      - icon: github
        href: https://github.com/yo5uke/population_heatmap
lang: ja
server: shiny
---

```{r}
#| context: setup

library(shiny)
library(shinyWidgets)
library(tidyverse)
library(sf)
library(leaflet)
source("helpers.R")
```

# {.sidebar}

```{r}
br()
helpText(
  "å¸‚ç”ºæ‘ã”ã¨ã®äººå£ã‚„å¹´é½¢åˆ¥äººå£ã¨ãã®å‰²åˆã€äººå£ã®å¢—åŠ ç‡ã‚’å›½å‹¢èª¿æŸ»ãƒ™ãƒ¼ã‚¹ã§å¯è¦–åŒ–ã—ã¦ã„ã¾ã™ã€‚", 
  br(), 
  "ä»¥ä¸‹ã®ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰è¡¨ç¤ºã—ãŸã„æŒ‡æ¨™ã¨å¹´ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚"
)

br()

selectInput("valueType", "å€¤ã®ç¨®é¡", 
            choices = c("äººå£", "äººå£å‰²åˆ", "äººå£å¢—åŠ ç‡"), 
            selected = "äººå£")

selectInput("ageCategory", "å¹´é½¢åŒºåˆ†", 
            choices = c("ç·äººå£", "15æ­³æœªæº€äººå£", "15æ­³ï½64æ­³äººå£", "65æ­³ä»¥ä¸Šäººå£"),
            selected = "ç·äººå£")

sliderTextInput("year", "è¡¨ç¤ºã™ã‚‹å¹´",
                choices = seq(1980, 2020, by = 5),
                selected = 2020,
                grid = TRUE)

br()

actionButton("show_help", "ğŸ›ˆ ç”¨èªèª¬æ˜ã‚’è¦‹ã‚‹")
br()
actionButton("show_source", "ğŸ“¦ ãƒ‡ãƒ¼ã‚¿å‡ºå…¸ç­‰")
```

# ãƒ—ãƒ­ãƒƒãƒˆ

```{r}
leafletOutput("map")
```

```{r}
#| context: server

# ---- ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— ----
observeEvent(input$show_help, {
  showModal(modalDialog(
    title = "ğŸ“ ç”¨èªèª¬æ˜",
    HTML("
      <ul style='padding-left: 20px;'>
        <li><b>äººå£å‰²åˆ</b>ï¼šå„å¹´é½¢éšå±¤ã®äººå£ Ã· å½“è©²å¹´ã®ç·äººå£ Ã— 100ï¼ˆ%ï¼‰</li>
        <li>
          <b>äººå£å¢—åŠ ç‡</b>ï¼š<br>
          ï¼ˆå½“è©²å¹´ã®äººå£ âˆ’ å‰å›èª¿æŸ»å¹´ã®äººå£ï¼‰ Ã· å‰å›èª¿æŸ»å¹´ã®äººå£ Ã— 100ï¼ˆ%ï¼‰<br>
          â€» æ­£ã®å€¤ï¼šå¢—åŠ ã€è² ã®å€¤ï¼šæ¸›å°‘
        </li>
      </ul>
    "),
    easyClose = TRUE,
    footer = modalButton("é–‰ã˜ã‚‹"), 
    size = "l"
  ))
})

observeEvent(input$show_source, {
  showModal(modalDialog(
    title = "ğŸ“¦ ãƒ‡ãƒ¼ã‚¿å‡ºå…¸ãƒ»ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ãƒ»ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰",
    HTML("
      <div style='line-height: 1.6; font-size: 95%;'>
        <h4>ğŸ“Š ãƒ‡ãƒ¼ã‚¿å‡ºå…¸</h4>
        <p>æœ¬ã‚¢ãƒ—ãƒªã§ã¯ã€ä»¥ä¸‹ã®ãƒ‡ãƒ¼ã‚¿ã‚’ã‚‚ã¨ã«ä½œæˆã—ã¦ã„ã¾ã™ã€‚</p>
        <ul style='padding-left: 20px;'>
          <li>
            ç·å‹™çœçµ±è¨ˆå±€ã€å›½å‹¢èª¿æŸ»ã€ï¼ˆ1980ï½2020å¹´ï¼‰<br>
            <a href='https://www.e-stat.go.jp/stat-search?page=1&toukei=00200521&survey=%E5%9B%BD%E5%8B%A2%E8%AA%BF%E6%9F%BB' target='_blank'>
              e-Statã®å›½å‹¢èª¿æŸ»ãƒšãƒ¼ã‚¸
            </a>
          </li>
          <li>
            å›½åœŸæ•°å€¤æƒ…å ±ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚µã‚¤ãƒˆï¼š<br>
            <a href='https://nlftp.mlit.go.jp/ksj/gml/datalist/KsjTmplt-N03-2024.html' target='_blank'>
              2024å¹´1æœˆ1æ—¥æ™‚ç‚¹ã®è¡Œæ”¿åŒºåŸŸãƒ‡ãƒ¼ã‚¿
            </a><br>
            â€» ãƒ‡ãƒ¼ã‚¿è»½é‡åŒ–ã®ãŸã‚ <code>rmapshaper::ms_simplify()</code> ã‚’ä½¿ç”¨ã—ã¦ç°¡ç´ åŒ–ã—ã¦ã„ã¾ã™ã€‚
          </li>
        </ul>

        <h4>ğŸ“ ãƒ©ã‚¤ã‚»ãƒ³ã‚¹</h4>
        <p>
          ã“ã®ã‚¢ãƒ—ãƒªã¯ <strong>MITãƒ©ã‚¤ã‚»ãƒ³ã‚¹</strong> ã®ä¸‹ã§å…¬é–‹ã•ã‚Œã¦ã„ã¾ã™ã€‚<br>
          è‡ªç”±ã«åˆ©ç”¨ãƒ»æ”¹å¤‰ãŒå¯èƒ½ã§ã™ãŒã€è‘—ä½œæ¨©è¡¨ç¤ºã¨ãƒ©ã‚¤ã‚»ãƒ³ã‚¹æ–‡ã®ä¿æŒãŒå¿…è¦ã§ã™ã€‚
        </p>

        <h4>ğŸ”— ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰</h4>
        <p>
          GitHub ãƒªãƒã‚¸ãƒˆãƒªã¯ã“ã¡ã‚‰ï¼š<br>
          <a href='https://github.com/yo5uke/population_heatmap' target='_blank'>
            https://github.com/yo5uke/population_heatmap
          </a>
        </p>
      </div>
    "),
    easyClose = TRUE,
    footer = modalButton("é–‰ã˜ã‚‹"),
    size = "l"
  ))
})

# ---- å€¤ã®ç¨®é¡ ----
observe({
  if (input$valueType == "äººå£") {
    updateSelectInput(session, "ageCategory", 
                      choices = c("ç·äººå£", "15æ­³æœªæº€äººå£", "15ï½64æ­³äººå£", "65æ­³ä»¥ä¸Šäººå£"),
                      selected = "ç·äººå£")
  } else if (input$valueType == "äººå£å‰²åˆ") {
    updateSelectInput(session, "ageCategory", 
                      choices = c("15æ­³æœªæº€äººå£å‰²åˆ", "15ï½64æ­³äººå£å‰²åˆ", "65æ­³ä»¥ä¸Šäººå£å‰²åˆ"),
                      selected = "15æ­³æœªæº€äººå£å‰²åˆ")
  } else if (input$valueType == "äººå£å¢—åŠ ç‡") {
    updateSelectInput(session, "ageCategory", 
                      choices = c("äººå£å¢—åŠ ç‡", "15æ­³æœªæº€äººå£å¢—åŠ ç‡", "15ï½64æ­³äººå£å¢—åŠ ç‡", "65æ­³ä»¥ä¸Šäººå£å¢—åŠ ç‡"),
                      selected = "äººå£å¢—åŠ ç‡")
  }
})

# ---- ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã®ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆ ----
observe({
  if (input$valueType == "äººå£å¢—åŠ ç‡") {
    updateSliderTextInput(session, "year",
                          choices = seq(1985, 2020, 5),
                          selected = max(1985, input$year))
  } else {
    # äººå£å¢—åŠ ç‡ã‹ã‚‰ä»–ã¸ç§»ã£ãŸéš›ã«å†åº¦1980å¹´ã‚’è¡¨ç¤ºã™ã‚‹
    updateSliderTextInput(session, "year",
                          choices = seq(1980, 2020, 5),
                          selected = input$year)
  }
})

# ---- ã‚¿ã‚¤ãƒ—ã”ã¨ã«å¤‰æ•°ã‚’æŠ½å‡º ----
selected_col <- reactive({
  if (input$valueType == "äººå£") {
    abs_map <- c(
      "ç·äººå£"             = "population",
      "15æ­³æœªæº€äººå£"       = "pop_u15",
      "15ï½64æ­³äººå£"       = "pop_15to64",
      "65æ­³ä»¥ä¸Šäººå£"       = "pop_o65"
    )
    abs_map[input$ageCategory]
  } else if (input$valueType == "äººå£å‰²åˆ") {
    ratio_map <- c(
      "15æ­³æœªæº€äººå£å‰²åˆ" = "pct_u15",
      "15ï½64æ­³äººå£å‰²åˆ" = "pct_15to64",
      "65æ­³ä»¥ä¸Šäººå£å‰²åˆ" = "pct_o65"
    )
    ratio_map[input$ageCategory]
  } else if (input$valueType == "äººå£å¢—åŠ ç‡") {
    inc_map <- c(
      "äººå£å¢—åŠ ç‡"         = "pct_inc_pop",
      "15æ­³æœªæº€äººå£å¢—åŠ ç‡" = "pct_inc_u15",
      "15ï½64æ­³äººå£å¢—åŠ ç‡" = "pct_inc_15to64",
      "65æ­³ä»¥ä¸Šäººå£å¢—åŠ ç‡" = "pct_inc_o65"
    )
    inc_map[input$ageCategory]
  }
})


# ---- ãƒãƒƒãƒ—ã®ãƒ—ãƒ­ãƒƒãƒˆ ----
observe({
  req(input$year, input$ageCategory, input$valueType)
  
  # ----é€²æ—è¡¨ç¤º----
  withProgress(message = "åœ°å›³ã‚’æ›´æ–°ä¸­â€¦", value = 0, {
    
    incProgress(0.2, detail = "è©²å½“å¹´ã®ãƒ‡ãƒ¼ã‚¿ã‚’æŠ½å‡ºä¸­")
    
    # ---- 1. å¹´ã¨å¤‰æ•°ã®æŠ½å‡º ----
    if (input$valueType == "äººå£å¢—åŠ ç‡") {
      
      # è©²å½“å¹´ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
      df_year <- df_gis |> 
        filter(year == input$year)
      
      ## è©²å½“å¹´ã«ãƒ‡ãƒ¼ã‚¿ãŒãªã‹ã£ãŸå ´åˆã®è­¦å‘Š
      if (nrow(df_year) == 0) {
        showNotification("é¸æŠã—ãŸå¹´ã®ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚", type = "warning")
        return()
      }
      
      incProgress(0.2, detail = "è©²å½“å¤‰æ•°ã®æŠ½å‡ºä¸­")
      
      # å¤‰æ•°ã‚’æŠ½å‡º
      col_name <- selected_col()
      
      if (is.na(col_name)) {
        return()
      }
      
      df_year <- df_year |> 
        mutate(val = .data[[col_name]]) |> 
        mutate(val_bin = pmax(pmin(val, 15), -15))
      
      ## è¡¨ç¤ºã§ãã‚‹ãƒ‡ãƒ¼ã‚¿ãŒãªã‹ã£ãŸå ´åˆã®ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
      if (all(is.na(df_year$val))) {
        showNotification("é¸æŠã—ãŸå¹´ã®ãƒ‡ãƒ¼ã‚¿ã«ã¯æœ‰åŠ¹ãªå€¤ãŒã‚ã‚Šã¾ã›ã‚“ã€‚", type = "error")
        return()
      }
      
    } else if (input$valueType == "äººå£å‰²åˆ") {
      
      # è©²å½“å¹´ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
      df_year <- df_gis |> 
        filter(year == input$year)
      
      ## è©²å½“å¹´ã«ãƒ‡ãƒ¼ã‚¿ãŒãªã‹ã£ãŸå ´åˆã®è­¦å‘Š
      if (nrow(df_year) == 0) {
        showNotification("é¸æŠã—ãŸå¹´ã®ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚", type = "warning")
        return()
      }
      
      incProgress(0.2, detail = "è©²å½“å¤‰æ•°ã®æŠ½å‡ºä¸­")
      
      # å¤‰æ•°ã‚’æŠ½å‡º
      col_name <- selected_col()
      
      if (is.na(col_name)) {
        return()
      }
      
      if (col_name == "pct_u15") {
        
        df_year <- df_year |> 
          mutate(val = .data[[col_name]]) |> 
          mutate(val_bin = pmax(pmin(val, 30), 0))
        
      } else if (col_name == "pct_o65") {
        
        df_year <- df_year |> 
          mutate(val = .data[[col_name]]) |> 
          mutate(val_bin = pmax(pmin(val, 40), 0))
        
      } else {
        
        df_year <- df_year |> 
          mutate(val = .data[[col_name]]) |> 
          mutate(val_bin = pmax(pmin(val, 70), 0))
        
      }
      
    } else {
      
      # è©²å½“å¹´ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
      df_year <- df_gis |> 
        filter(year == input$year)
      
      ## è©²å½“å¹´ã«ãƒ‡ãƒ¼ã‚¿ãŒãªã‹ã£ãŸå ´åˆã®è­¦å‘Š
      if (nrow(df_year) == 0) {
        showNotification("é¸æŠã—ãŸå¹´ã®ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚", type = "warning")
        return()
      }
      
      incProgress(0.2, detail = "è©²å½“å¤‰æ•°ã®æŠ½å‡ºä¸­")
      
      # å¤‰æ•°ã‚’æŠ½å‡º
      col_name <- selected_col()
      
      if (is.na(col_name)) {
        return()
      }
      
      df_year <- df_year |> 
        mutate(val = .data[[col_name]]) |> 
        mutate(val_bin = pmax(pmin(val, 3000000), 0))
      
      ## è¡¨ç¤ºã§ãã‚‹ãƒ‡ãƒ¼ã‚¿ãŒãªã‹ã£ãŸå ´åˆã®ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
      if (all(is.na(df_year$val))) {
        showNotification("é¸æŠã—ãŸå¹´ã®ãƒ‡ãƒ¼ã‚¿ã«ã¯æœ‰åŠ¹ãªå€¤ãŒã‚ã‚Šã¾ã›ã‚“ã€‚", type = "error")
        return()
      }
      
    }
    
    
    # ---- 2. ãƒ—ãƒ­ãƒƒãƒˆã®ãƒ™ãƒ¼ã‚¹ä½œæˆ ----
    incProgress(0.2, detail = "ã‚«ãƒ©ãƒ¼ãƒ‘ãƒ¬ãƒƒãƒˆä½œæˆä¸­")
    
    ## ã‚«ãƒ©ãƒ¼ãƒ‘ãƒ¬ãƒƒãƒˆã®ä½œæˆ
    if (input$valueType == "äººå£å¢—åŠ ç‡") {
      
      breaks <- c(-20, -15, -10, -5, 0, 5, 10, 15, 20)
      pal <- colorBin("RdYlBu", domain = df_year$val_bin, bins = breaks, reverse = TRUE)
      
    } else if (input$valueType == "äººå£å‰²åˆ") {
      
      breaks1 <- c(0, 5, 10, 15, 20, 25, 30, 35)
      breaks2 <- c(30, 40, 50, 60, 70, 80, 90)
      breaks3 <- c(0, 5, 10, 15, 20, 25,  30, 35, 40, 45)
      pal1 <- colorBin("YlGnBu", domain = df_year$val_bin, bins = breaks1)
      pal2 <- colorBin("YlGnBu", domain = df_year$val_bin, bins = breaks2)
      pal3 <- colorBin("YlGnBu", domain = df_year$val_bin, bins = breaks3)
      
    } else if (input$valueType == "äººå£") {
      
      breaks <- c(0, 10000, 50000, 100000, 200000, 300000, 500000, 750000, 1000000, 2000000, 3000000)
      pal <- colorBin("YlOrRd", domain = df_year$val, bins = breaks)
      
    }
    
    ## å‡¡ä¾‹ã‚¿ã‚¤ãƒˆãƒ«ã¨popupãƒ†ã‚­ã‚¹ãƒˆã®ä½œæˆ
    legend_title <- case_when(
      
      input$valueType == "äººå£" ~ 
        paste0(input$ageCategory, "ï¼ˆä¸‡äººï¼‰<br>", input$year, "å¹´"), 
      
      input$valueType == "äººå£å‰²åˆ" ~ 
        paste0(input$ageCategory, "ï¼ˆ%ï¼‰<br>", input$year, "å¹´"), 
      
      input$valueType == "äººå£å¢—åŠ ç‡" ~ 
        paste0(input$ageCategory, "ï¼ˆ%ï¼‰<br>", input$year, "å¹´")
      
    )
    
    popup_text <- case_when(
      
      input$valueType == "äººå£" ~ 
        if_else(
          is.na(df_year$val), 
          paste0(df_year$name_muni, "<br>", input$year, "å¹´å›½å‹¢èª¿æŸ»", 
               "<br>", "ãƒ‡ãƒ¼ã‚¿ãŒæ¬ æã—ã¦ã„ã¾ã™ã€‚"), 
          paste0(df_year$name_muni, "<br>", input$year, "å¹´å›½å‹¢èª¿æŸ»", 
               "<br>", format(df_year$val, big.mark = ","), "äºº")
        ), 
      
      input$valueType == "äººå£å‰²åˆ" ~ 
        if_else(
          is.na(df_year$val), 
          paste0(df_year$name_muni, "<br>", input$year, "å¹´å›½å‹¢èª¿æŸ»", 
                 "<br>å‰²åˆï¼š", "ãƒ‡ãƒ¼ã‚¿ãŒæ¬ æã—ã¦ã„ã¾ã™ã€‚"), 
          paste0(df_year$name_muni, "<br>", input$year, "å¹´å›½å‹¢èª¿æŸ»", 
                 "<br>å‰²åˆï¼š", df_year$val, "%")
        ), 
      
      input$valueType == "äººå£å¢—åŠ ç‡" ~ 
        if_else(
          is.na(df_year$val), 
          paste0(df_year$name_muni, "<br>", input$year, "å¹´å›½å‹¢èª¿æŸ»", 
                 "<br>å‰å›å›½å‹¢èª¿æŸ»æ¯”ï¼š", "ãƒ‡ãƒ¼ã‚¿ãŒæ¬ æã—ã¦ã„ã¾ã™ã€‚"), 
          if_else(
            df_year$val >= 0, 
            paste0(df_year$name_muni, "<br>", input$year, "å¹´å›½å‹¢èª¿æŸ»", 
                   "<br>å‰å›å›½å‹¢èª¿æŸ»æ¯”ï¼š+", df_year$val, "%"), 
            paste0(df_year$name_muni, "<br>", input$year, "å¹´å›½å‹¢èª¿æŸ»", 
                   "<br>å‰å›å›½å‹¢èª¿æŸ»æ¯”ï¼š", df_year$val, "%")
          )
        )
      
    )
    
    
    # ---- 3. åœ°å›³ã®æ›´æ–° ----
    incProgress(0.2, detail = "åœ°å›³æ›´æ–°ä¸­")
    
    if (input$valueType == "äººå£å¢—åŠ ç‡") {
      
      leafletProxy("map", data = df_year) |> 
        clearShapes() |> 
        clearControls() |> 
        addPolygons(
          fillColor = ~pal(val_bin),
          color = "white",
          weight = 1,
          opacity = 1,
          fillOpacity = 0.7,
          label = df_year$name_muni,
          popup = popup_text
        ) |> 
        addLegend(
          pal = pal,
          values = df_year$val_bin,
          title = legend_title,
          position = "bottomright", 
          labFormat = function(type, cuts, p) {
            cuts <- as.numeric(cuts)
            n <- length(cuts)
            labels <- vector("character", n - 1)
            labels[1] <- paste0(cuts[2], "%ä»¥ä¸‹")
            if (n > 3) {
              for (i in 2:(n - 2)) {
                labels[i] <- paste0(cuts[i], " ï½ ", cuts[i + 1], "%")
              }
            }
            labels[n - 1] <- paste0(cuts[n - 1], "%ä»¥ä¸Š")
            return(labels)
          }
        )
      
    } else if (input$valueType == "äººå£å‰²åˆ") {
      
      if (col_name == "pct_u15") {
        
        leafletProxy("map", data = df_year) |> 
          clearShapes() |> 
          clearControls() |> 
          addPolygons(
            fillColor = ~pal1(val_bin),
            color = "white",
            weight = 1,
            opacity = 1,
            fillOpacity = 0.7,
            label = df_year$name_muni,
            popup = popup_text
          ) |> 
          addLegend(
            pal = pal1,
            values = df_year$val_bin,
            title = legend_title,
            position = "bottomright", 
            labFormat = function(type, cuts, p) {
              cuts <- as.numeric(cuts)
              n <- length(cuts)
              labels <- vector("character", n - 1)
              for (i in 1:(n - 2)) {
                labels[i] <- paste0(cuts[i], " ï½ ", cuts[i + 1], "%")
              }
              labels[n - 1] <- paste0(cuts[n - 1], "%ä»¥ä¸Š")
              return(labels)
            }
          )
        
      } else if (col_name == "pct_o65") {
        
        leafletProxy("map", data = df_year) |> 
          clearShapes() |> 
          clearControls() |> 
          addPolygons(
            fillColor = ~pal3(val_bin),
            color = "white",
            weight = 1,
            opacity = 1,
            fillOpacity = 0.7,
            label = df_year$name_muni,
            popup = popup_text
          ) |> 
          addLegend(
            pal = pal3,
            values = df_year$val_bin,
            title = legend_title,
            position = "bottomright", 
            labFormat = function(type, cuts, p) {
              cuts <- as.numeric(cuts)
              n <- length(cuts)
              labels <- vector("character", n - 1)
              for (i in 1:(n - 2)) {
                labels[i] <- paste0(cuts[i], " ï½ ", cuts[i + 1], "%")
              }
              labels[n - 1] <- paste0(cuts[n - 1], "%ä»¥ä¸Š")
              return(labels)
            }
          )
        
      } else {
        
        leafletProxy("map", data = df_year) |> 
          clearShapes() |> 
          clearControls() |> 
          addPolygons(
            fillColor = ~pal2(val),
            color = "white",
            weight = 1,
            opacity = 1,
            fillOpacity = 0.7,
            label = df_year$name_muni,
            popup = popup_text
          ) |> 
          addLegend(
            pal = pal2,
            values = df_year$val_bin,
            title = legend_title,
            position = "bottomright", 
            labFormat = function(type, cuts, p) {
              cuts <- as.numeric(cuts)
              n <- length(cuts)
              labels <- vector("character", n - 1)
              labels[1] <- paste0(cuts[2], "%ä»¥ä¸‹")
              for (i in 2:(n - 2)) {
                labels[i] <- paste0(cuts[i], " ï½ ", cuts[i + 1], "%")
              }
              labels[n - 1] <- paste0(cuts[n - 1], "%ä»¥ä¸Š")
              return(labels)
            }
          )
        
      }
      
    } else {
      
      leafletProxy("map", data = df_year) |> 
        clearShapes() |> 
        clearControls() |> 
        addPolygons(
          fillColor = ~pal(val_bin),
          color = "white",
          weight = 1,
          opacity = 1,
          fillOpacity = 0.7,
          label = df_year$name_muni,
          popup = popup_text
        ) |> 
        addLegend(
          pal = pal,
          values = df_year$val,
          title = legend_title,
          position = "bottomright", 
          labFormat = function(type, cuts, p) {
            cuts <- as.numeric(cuts) / 10000
            n <- length(cuts)
            labels <- vector("character", n - 1)
            for (i in 1:(n - 2)) {
              labels[i] <- paste0(cuts[i], " ï½ ", cuts[i + 1], "ä¸‡äºº")
            }
            labels[n - 1] <- paste0(cuts[n - 1], "ä¸‡äººä»¥ä¸Š")
            return(labels)
          }
        )
      
    }
    
    incProgress(1.0, detail = "ã¾ã‚‚ãªãè¡¨ç¤ºã•ã‚Œã¾ã™")
  })
})

output$map <- renderLeaflet({
  leaflet() |> 
    addTiles() |> 
    setView(lng = 138.36834, lat = 38.01827, zoom = 6)
})
```
