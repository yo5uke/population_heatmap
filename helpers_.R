#############################################
##### e-StatよりAPIを使ってデータを取得 #####
#############################################

url_template <- "https://api.e-stat.go.jp/rest/3.0/app/getStatsData?cdArea=01100%2C01202%2C01203%2C01204%2C01205%2C01206%2C01207%2C01208%2C01209%2C01210%2C01211%2C01212%2C01213%2C01214%2C01215%2C01216%2C01217%2C01218%2C01219%2C01220%2C01221%2C01222%2C01223%2C01224%2C01225%2C01226%2C01227%2C01228%2C01229%2C01230%2C01231%2C01233%2C01234%2C01235%2C01236%2C01303%2C01304%2C01331%2C01332%2C01333%2C01334%2C01337%2C01343%2C01345%2C01346%2C01347%2C01361%2C01362%2C01363%2C01364%2C01367%2C01370%2C01371%2C01391%2C01392%2C01393%2C01394%2C01395%2C01396%2C01397%2C01398%2C01399%2C01400%2C01401%2C01402%2C01403%2C01404%2C01405%2C01406%2C01407%2C01408%2C01409%2C01423%2C01424%2C01425%2C01427%2C01428%2C01429%2C01430%2C01431%2C01432%2C01433%2C01434%2C01436%2C01437%2C01438%2C01452%2C01453%2C01454%2C01455%2C01456%2C01457%2C01458%2C01459%2C01460%2C01461%2C01462%2C01463%2C01464%2C01465&cdTime=2020100000%2C2015100000%2C2010100000%2C2005100000%2C2000100000&cdCat01=A1101%2CA1301%2CA1302%2CA1303&lang=J&statsDataId=0000020201&metaGetFlg=Y&cntGetFlg=N&explanationGetFlg=Y&annotationGetFlg=Y&sectionHeaderFlg=1&replaceSpChars=0"

appId <- Sys.getenv("E_STAT_APP_ID")

url <- paste0(url_template, "&appId=", appId)

response <- GET(url)

if (status_code(response) == 200) {
  xml_data <- read_xml(content(response, as = "text", encoding = "UTF-8"))
}

# xml_structure(xml_data)

value_nodes <- xml_find_all(xml_data, "//DATA_INF/VALUE")

df <- tibble(
  area     = xml_attr(value_nodes, "area"),
  time     = xml_attr(value_nodes, "time"),
  category = xml_attr(value_nodes, "cat01"),
  value    = as.numeric(xml_text(value_nodes))
) |> 
  rename(
    id_muni = area, 
    year    = time
  ) |> 
  mutate(
    year = str_sub(year, 1, 4) |> 
      as.integer(), 
    category = case_when(
      category == "A1101" ~ "population", 
      category == "A1301" ~ "pop_u15", 
      category == "A1302" ~ "pop_15to64", 
      category == "A1303" ~ "pop_o65"
    )
  ) |> 
  arrange(id_muni, year) |> 
  pivot_wider(
    names_from  = category, 
    values_from = value
  )

######################################
##### シェープファイルの読み込み #####
######################################

seirei_ward <- tibble(
  id_ward2024 = c("01101", "01102", "01103", "01104", "01105", "01106", "01107", "01108", "01109", "01110", "04101", "04102", "04103", "04104", "04105", "11101", "11102", "11103", "11104", "11105", "11106", "11107", "11108", "11109", "11110", "12101", "12102", "12103", "12104", "12105", "12106", "14101", "14102", "14103", "14104", "14105", "14106", "14107", "14108", "14109", "14110", "14111", "14112", "14113", "14114", "14115", "14116", "14117", "14118", "14131", "14132", "14133", "14134", "14135", "14136", "14137", "14151", "14152", "14153", "15101", "15102", "15103", "15104", "15105", "15106", "15107", "15108", "22101", "22102", "22103", "22138", "22138", "22138", "22138", "22139", "22139", "22140", "23101", "23102", "23103", "23104", "23105", "23106", "23107", "23108", "23109", "23110", "23111", "23112", "23113", "23114", "23115", "23116", "26101", "26102", "26103", "26104", "26105", "26106", "26107", "26108", "26109", "26110", "26111", "27102", "27103", "27104", "27106", "27107", "27108", "27109", "27111", "27113", "27114", "27115", "27116", "27117", "27118", "27119", "27120", "27121", "27122", "27123", "27124", "27125", "27126", "27127", "27128", "27141", "27142", "27143", "27144", "27145", "27146", "27147", "28101", "28102", "28105", "28106", "28107", "28108", "28109", "28110", "28111", "33101", "33102", "33103", "33104", "34101", "34102", "34103", "34104", "34105", "34106", "34107", "34108", "40101", "40103", "40105", "40106", "40107", "40108", "40109", "40131", "40132", "40133", "40134", "40135", "40136", "40137", "43101", "43102", "43103", "43104", "43105"), 
  id_muni2020 = c("01100", "01100", "01100", "01100", "01100", "01100", "01100", "01100", "01100", "01100", "04100", "04100", "04100", "04100", "04100", "11100", "11100", "11100", "11100", "11100", "11100", "11100", "11100", "11100", "11100", "12100", "12100", "12100", "12100", "12100", "12100", "14100", "14100", "14100", "14100", "14100", "14100", "14100", "14100", "14100", "14100", "14100", "14100", "14100", "14100", "14100", "14100", "14100", "14100", "14130", "14130", "14130", "14130", "14130", "14130", "14130", "14150", "14150", "14150", "15100", "15100", "15100", "15100", "15100", "15100", "15100", "15100", "22100", "22100", "22100", "22130", "22130", "22130", "22130", "22130", "22130", "22130", "23100", "23100", "23100", "23100", "23100", "23100", "23100", "23100", "23100", "23100", "23100", "23100", "23100", "23100", "23100", "23100", "26100", "26100", "26100", "26100", "26100", "26100", "26100", "26100", "26100", "26100", "26100", "27100", "27100", "27100", "27100", "27100", "27100", "27100", "27100", "27100", "27100", "27100", "27100", "27100", "27100", "27100", "27100", "27100", "27100", "27100", "27100", "27100", "27100", "27100", "27100", "27140", "27140", "27140", "27140", "27140", "27140", "27140", "28100", "28100", "28100", "28100", "28100", "28100", "28100", "28100", "28100", "33100", "33100", "33100", "33100", "34100", "34100", "34100", "34100", "34100", "34100", "34100", "34100", "40100", "40100", "40100", "40100", "40100", "40100", "40100", "40130", "40130", "40130", "40130", "40130", "40130", "40130", "43100", "43100", "43100", "43100", "43100"), 
)

load_gis_data <- function(shp_path = "data/jp_muni.shp",
                          rds_path = "data/jp_muni.rds",
                          target_crs = 6668) {
  if (file.exists(rds_path)) {
    gis <- read_rds(rds_path)
  } else {
    gis <- read_sf(shp_path) |> 
      left_join(seirei_ward, by = c("N03_007" = "id_ward2024")) |> 
      mutate(id_muni = if_else(!is.na(id_muni2020), id_muni2020, N03_007)) |> 
      select(id_muni, geometry)
    write_rds(gis, rds_path)
  }
  return(gis)
}

gis <- load_gis_data()


################################
##### データフレームの作成 #####
################################

df_gis <- df |> 
  left_join(gis, by = "id_muni") |> 
  st_as_sf()
